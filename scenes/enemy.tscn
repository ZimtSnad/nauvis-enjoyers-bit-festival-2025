[gd_scene load_steps=4 format=3 uid="uid://h63ml1lelyen"]

[ext_resource type="Texture2D" uid="uid://58ld0a2frvv0" path="res://icon.svg" id="2_md0e3"]

[sub_resource type="GDScript" id="GDScript_7p1mj"]
script/source = "extends Node2D

@export var enemy_type: Enemy_types.Type = Enemy_types.Type.LIGHT
@export var enemy_mod: Enemy_modifiers.Mod = Enemy_modifiers.Mod.NONE

var health: int
var damage: int
var speed: float
var delay_between_bite: float
var attack_range: float

@export var turret_path: NodePath 

@onready var timer: Timer = $Timer
@onready var turret: Node2D = get_node(turret_path)

var attacking: bool = false


func _ready() -> void:
	var base = Enemy_types.BASE_DATA[enemy_type]
	var mod = Enemy_modifiers.MOD_DATA[enemy_mod]

	health = int(base[\"health\"] * mod[\"health_mult\"])
	damage = int(base[\"damage\"] * mod[\"damage_mult\"])
	speed = base[\"speed\"] * mod[\"speed_mult\"]

	delay_between_bite = base[\"delay_between_bite\"] * mod[\"delay_mult\"]
	attack_range = base[\"attack_range\"] * mod[\"range_mult\"]

	print(\"=== Enemy config ===\")
	print(\"Type:\", enemy_type, \" Mod:\", enemy_mod)
	print(\"HP:\", health)
	print(\"DMG:\", damage)
	print(\"SPD:\", speed)
	print(\"DELAY:\", delay_between_bite)
	print(\"RANGE:\", attack_range)
	
	timer.one_shot = true
	timer.wait_time = delay_between_bite
	add_to_group(\"enemies\")


func _physics_process(delta: float) -> void:
	if turret == null or !is_instance_valid(turret):
		return

	if attacking:
		return

	var dist := global_position.distance_to(turret.global_position)

	if dist > attack_range:
		var dir := (turret.global_position - global_position).normalized()
		global_position += dir * speed * delta
	else:
		attack_turret()


func attack_turret() -> void:
	if attacking:
		return
	attacking = true

	while turret != null and is_instance_valid(turret):
		# upewniamy się, że turret ma zdrowie
		#if not turret.has_variable(\"health\"):
			#break

		turret.health -= damage
		print(\"enemy hits turret, dmg:\", damage, \" turret hp:\", turret.health)

		if turret.health <= 0:
			print(\"turret destroyed\")
			# możesz np.:
			# turret.queue_free()
			break

		timer.start()
		await timer.timeout

	attacking = false
"

[sub_resource type="RectangleShape2D" id="RectangleShape2D_md0e3"]
size = Vector2(111.99999, 112.00001)

[node name="Enemy" type="CharacterBody2D" groups=["enemies"]]
collision_layer = 4
collision_mask = 4
script = SubResource("GDScript_7p1mj")

[node name="Timer" type="Timer" parent="."]

[node name="Sprite2D" type="Sprite2D" parent="."]
position = Vector2(64.12501, 64.30473)
scale = Vector2(0.99804693, 0.9952386)
texture = ExtResource("2_md0e3")

[node name="CollisionShape2D" type="CollisionShape2D" parent="." groups=["enemies"]]
position = Vector2(64, 64)
rotation = 1.5707964
shape = SubResource("RectangleShape2D_md0e3")
